syntax = "proto3";

package nexus.controlplane.v1;

import "google/protobuf/timestamp.proto";
import "nexus/controlplane/v1/control_plane.proto";

option go_package = "github.com/liquidspill/proto/go/nexus/controlplane/v1;controlplanev1";


// The frontend service handles RPCs specifically that the frontend uses. They still
// interact with the control plane but are split out since they logically serve a
// different purpose
service FrontendService {
  // Get metrics for a collector
  rpc BatchGetCollectorMetrics(BatchGetCollectorMetricsRequest) returns (BatchGetCollectorMetricsResponse) {}

  // Get summary stats for a team
  rpc GetTeamSummary(GetTeamSummaryRequest) returns (GetTeamSummaryResponse) {}

  // Get a list of queryable fields
  rpc GetQueryableFields(GetQueryableFieldsRequest) returns (GetQueryableFieldsResponse) {}
}

message BatchGetCollectorMetricsRequest {
  repeated string id = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
}

message BatchGetCollectorMetricsResponse {
  map<string, ListCollectorMetrics> metrics = 1;
}

message ListCollectorMetrics {
  repeated CollectorMetrics metrics = 1;
}

message GetTeamSummaryRequest {
  string team_pid = 1;
}

message GetTeamSummaryResponse {
  string team_pid = 1;
  CollectorSummaryStats collector_summary_stats = 2;
}

message CollectorSummaryStats {
  int32 active_collectors_total = 2;
  int32 stale_collectors_total = 3;
  int32 unresponsive_collectors_total = 4;
  int32 flows_per_second_total = 5;

  // Weighted average of avg_s3_put_latency_ms across collectors.
  // Formula: sum(avg_s3_put_latency_ms * s3_put_requests_total) / sum(s3_put_requests_total)
  double avg_s3_put_latency_ms = 6;
  // Average of p99_s3_put_latency_ms across collectors.
  // Formula: sum(p99_s3_put_latency_ms) / count(collectors)
  double avg_p99_s3_put_latency_ms = 7;
  // Maximum p99_s3_put_latency_ms across collectors.
  // Formula: max(p99_s3_put_latency_ms)
  double max_p99_s3_put_latency_ms = 8;
}

message GetQueryableFieldsRequest {
  string dataset_pid = 1;
}

message GetQueryableFieldsResponse {
  repeated Field fields = 1;
}

message Field {
  string name = 1;
}
